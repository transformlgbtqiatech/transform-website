---
import Label from "./Label.astro";
import Input from "./Input.astro";
import LabelDescription from "./LabelDescription.astro";
import Select from "./Select.astro";
import TextArea from "./TextArea.astro";
import { getCollection } from "astro:content";
import { submitTypeSelectOptions } from "./select-options";

const identityGroups = await getCollection("identity-groups");
const violenceSubCategories = await getCollection("violence-sub-categories");

const identitySelectOptions = identityGroups.map((identityGroup) => {
  return {
    value: identityGroup.id,
    text: identityGroup.data.name,
  };
});

const violenceSubCategorySelectOptions = violenceSubCategories.map(
  (violenceSubCategory) => {
    return {
      value: violenceSubCategory.id,
      text: violenceSubCategory.data.name,
    };
  },
);
---

<form action="post" class="flex flex-col gap-4 lg:max-w-[400px] flex-1">
  <Label labelText="Name">
    <div>
      <Input name="name" placeholder="Your Name" />
      <LabelDescription> Leave empty to stay anonymous </LabelDescription>
    </div>
  </Label>

  <Label labelText="Email">
    <Input name="email" placeholder="Your Email" />
  </Label>

  <Label labelText="Please choose a subject">
    <Select nameAndId="contact-submit-type" options={submitTypeSelectOptions} />
  </Label>

  <Label
    labelText="Identity Group"
    className="hidden"
    id="identity-group-select-label"
  >
    <Select nameAndId="identity-group" options={identitySelectOptions} />
  </Label>

  <Label
    labelText="Violence Sub Category"
    className="hidden"
    id="violence-sub-category-select-label"
  >
    <Select
      nameAndId="violence-sub-category"
      options={violenceSubCategorySelectOptions}
    />
  </Label>

  <Label labelText="Your message">
    <TextArea nameAndId="message" />
  </Label>

  <button
    class="text-left font-medium bg-yellow-transform text-white lg:w-fit px-5 py-2 rounded-full"
  >
    Submit
  </button>
</form>

<script>
  //
  //
  import type { SubmitType } from "./select-options";
  const identityGroupSelectLabelEl = document.querySelector(
    "#identity-group-select-label",
  ) as HTMLLabelElement;

  const violenceSubCategorySelectLabelEl = document.querySelector(
    "#violence-sub-category-select-label",
  ) as HTMLLabelElement;

  const submitTypeEl = document.querySelector(
    "#contact-submit-type",
  ) as HTMLSelectElement;

  const conditionalEls = [
    identityGroupSelectLabelEl,
    violenceSubCategorySelectLabelEl,
  ];

  function showConditionalFormFields() {
    conditionalEls.forEach((el) => {
      el.classList.remove("hidden");
    });
  }

  function hideConditionalFormFields() {
    conditionalEls.forEach((el) => {
      el.classList.add("hidden");
    });
  }

  submitTypeEl.addEventListener("change", (e) => {
    const target = e.target as HTMLSelectElement;
    const value = target.value as SubmitType;

    if (value === "contribute") {
      showConditionalFormFields();
    } else {
      hideConditionalFormFields();
    }
  });
</script>
